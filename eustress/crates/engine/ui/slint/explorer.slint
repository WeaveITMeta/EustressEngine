// ============================================================================
// Eustress Engine Studio - Explorer Panel
// Hierarchical entity tree view with services
// ============================================================================

import { LineEdit, ScrollView } from "std-widgets.slint";
import { Theme, TreeItem } from "theme.slint";

// Entity data structure for the tree
export struct EntityNode {
    id: int,
    name: string,
    class-name: string,
    icon: image,
    depth: int,
    expandable: bool,
    expanded: bool,
    selected: bool,
    visible: bool,
}

export component ExplorerPanel inherits Rectangle {
    // Properties
    in property <[EntityNode]> entities: [];
    in-out property <string> search-text: "";
    
    // Callbacks
    callback on-select-entity(int);
    callback on-expand-entity(int);
    callback on-collapse-entity(int);
    callback on-context-menu(length, length);
    callback on-search-changed(string);
    callback on-rename-entity(int, string);
    
    background: Theme.panel-background;
    
    VerticalLayout {
        padding: 0px;
        spacing: 0px;
        
        // Search bar
        Rectangle {
            height: 30px;
            background: Theme.header-background;
            
            HorizontalLayout {
                padding: 4px;
                
                search-input := LineEdit {
                    horizontal-stretch: 1;
                    placeholder-text: "Search entities...";
                    text <=> root.search-text;
                    edited(text) => { root.on-search-changed(text); }
                }
            }
        }
        
        // Entity tree
        ScrollView {
            vertical-stretch: 1;
            
            VerticalLayout {
                padding: 0px;
                spacing: 0px;
                alignment: start;
                
                // ============================================================
                // Services â€” flat list matching egui explorer (13 services)
                // SVG icons from crates/engine/assets/icons/
                // ============================================================
                
                TreeItem {
                    depth: 0;
                    icon: @image-url("../../assets/icons/workspace.svg");
                    label: "Workspace";
                    expandable: true;
                    expanded: true;
                    clicked => { root.on-select-entity(-1); }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
                
                TreeItem {
                    depth: 0;
                    icon: @image-url("../../assets/icons/players.svg");
                    label: "Players";
                    expandable: true;
                    clicked => { root.on-select-entity(-2); }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
                
                TreeItem {
                    depth: 0;
                    icon: @image-url("../../assets/icons/lighting.svg");
                    label: "Lighting";
                    expandable: true;
                    clicked => { root.on-select-entity(-3); }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
                
                TreeItem {
                    depth: 0;
                    icon: @image-url("../../assets/icons/soulservice.svg");
                    label: "SoulService";
                    expandable: true;
                    clicked => { root.on-select-entity(-4); }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
                
                TreeItem {
                    depth: 0;
                    icon: @image-url("../../assets/icons/serverstorage.svg");
                    label: "ServerStorage";
                    expandable: true;
                    clicked => { root.on-select-entity(-5); }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
                
                TreeItem {
                    depth: 0;
                    icon: @image-url("../../assets/icons/startergui.svg");
                    label: "StarterGui";
                    expandable: true;
                    clicked => { root.on-select-entity(-6); }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
                
                TreeItem {
                    depth: 0;
                    icon: @image-url("../../assets/icons/starterpack.svg");
                    label: "StarterPack";
                    expandable: true;
                    clicked => { root.on-select-entity(-7); }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
                
                TreeItem {
                    depth: 0;
                    icon: @image-url("../../assets/icons/starterplayer.svg");
                    label: "StarterPlayer";
                    expandable: true;
                    clicked => { root.on-select-entity(-8); }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
                
                TreeItem {
                    depth: 0;
                    icon: @image-url("../../assets/icons/soundservice.svg");
                    label: "SoundService";
                    expandable: true;
                    clicked => { root.on-select-entity(-9); }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
                
                TreeItem {
                    depth: 0;
                    icon: @image-url("../../assets/icons/teams.svg");
                    label: "Teams";
                    expandable: true;
                    clicked => { root.on-select-entity(-10); }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
                
                TreeItem {
                    depth: 0;
                    icon: @image-url("../../assets/icons/chat.svg");
                    label: "Chat";
                    expandable: true;
                    clicked => { root.on-select-entity(-11); }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
                
                TreeItem {
                    depth: 0;
                    icon: @image-url("../../assets/icons/localizationservice.svg");
                    label: "LocalizationService";
                    expandable: true;
                    clicked => { root.on-select-entity(-12); }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
                
                TreeItem {
                    depth: 0;
                    icon: @image-url("../../assets/icons/testservice.svg");
                    label: "TestService";
                    expandable: true;
                    clicked => { root.on-select-entity(-13); }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
                
                // ============================================================
                // Dynamic entity list (pushed from Bevy each frame)
                // ============================================================
                for entity in root.entities: TreeItem {
                    depth: entity.depth;
                    icon: entity.icon;
                    label: entity.name;
                    expandable: entity.expandable;
                    expanded: entity.expanded;
                    selected: entity.selected;
                    show: entity.visible;
                    
                    clicked => { root.on-select-entity(entity.id); }
                    toggle-expanded => {
                        if entity.expanded {
                            root.on-collapse-entity(entity.id);
                        } else {
                            root.on-expand-entity(entity.id);
                        }
                    }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
            }
        }
    }
}
