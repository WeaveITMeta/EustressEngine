// ============================================================================
// Eustress Engine Studio - Explorer Panel
// Hierarchical entity tree view with services
// ============================================================================

import { LineEdit, ScrollView } from "std-widgets.slint";
import { Theme, TreeItem } from "theme.slint";

// Unified tree node for both ECS entities and filesystem items
export struct TreeNode {
    // Common fields
    id: int,
    name: string,
    icon: image,
    depth: int,
    expandable: bool,
    expanded: bool,
    selected: bool,
    visible: bool,
    
    // Type discriminator
    node-type: string,
    
    // Entity-specific (when node-type == "entity")
    class-name: string,
    
    // File-specific (when node-type == "file")
    path: string,
    is-directory: bool,
    extension: string,
    size: string,
    modified: bool,
}

export component ExplorerPanel inherits Rectangle {
    // Properties
    in property <[TreeNode]> tree-nodes: [];
    in-out property <string> search-text: "";
    
    // Callbacks
    callback on-select-node(int, string);
    callback on-expand-node(int, string);
    callback on-collapse-node(int, string);
    callback on-open-node(int, string);
    callback on-context-menu(length, length);
    callback on-search-changed(string);
    callback on-rename-node(int, string, string);
    
    background: Theme.panel-background;
    
    VerticalLayout {
        padding: 0px;
        spacing: 0px;
        
        // Search bar
        Rectangle {
            height: 30px;
            background: Theme.header-background;
            
            HorizontalLayout {
                padding: 4px;
                
                search-input := LineEdit {
                    horizontal-stretch: 1;
                    placeholder-text: "Search...";
                    text <=> root.search-text;
                    edited(text) => { root.on-search-changed(text); }
                }
            }
        }
        
        // Entity tree
        ScrollView {
            vertical-stretch: 1;
            
            VerticalLayout {
                spacing: 0px;
                
                // ============================================================
                // Unified tree: ECS entities + filesystem nodes
                // Rendered from single flat list with depth values
                // ============================================================
                for node in root.tree-nodes: TreeItem {
                    depth: node.depth;
                    icon: node.icon;
                    label: node.name;
                    expandable: node.expandable;
                    expanded: node.expanded;
                    selected: node.selected;
                    show: node.visible;
                    
                    clicked => { 
                        root.on-select-node(node.id, node.node-type);
                    }
                    double-clicked => {
                        root.on-open-node(node.id, node.node-type);
                    }
                    toggle-expanded => {
                        if node.expanded {
                            root.on-collapse-node(node.id, node.node-type);
                        } else {
                            root.on-expand-node(node.id, node.node-type);
                        }
                    }
                    context-menu(x, y) => { root.on-context-menu(x, y); }
                }
            }
        }
    }
}
