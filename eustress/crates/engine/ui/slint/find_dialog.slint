// ============================================================================
// Eustress Engine Studio - Find Dialog
// Search and replace in scene
// ============================================================================

import { VerticalBox, HorizontalBox, LineEdit, CheckBox, Button } from "std-widgets.slint";
import { Theme } from "theme.slint";

// Search result data
export struct SearchResultData {
    entity-id: int,
    name: string,
    class-name: string,
    path: string,
}

export component FindDialog inherits Rectangle {
    // Properties
    in-out property <string> search-text: "";
    in-out property <string> replace-text: "";
    in-out property <bool> case-sensitive: false;
    in-out property <bool> whole-word: false;
    in-out property <bool> use-regex: false;
    in property <[SearchResultData]> results: [];
    in property <int> current-result: -1;
    in property <int> total-results: 0;
    
    // Callbacks
    callback on-search();
    callback on-find-next();
    callback on-find-previous();
    callback on-replace();
    callback on-replace-all();
    callback on-select-result(int);
    callback on-close();
    
    width: 100%;
    height: 100%;
    background: transparent;
    
    // Position at top-right
    Rectangle {
        x: parent.width - self.width - 20px;
        y: 60px;
        width: 400px;
        height: root.results.length > 0 ? 360px : 180px;
        background: Theme.dialog-background;
        border-radius: 8px;
        border-width: 1px;
        border-color: Theme.border-color;
        drop-shadow-blur: 12px;
        drop-shadow-color: Theme.shadow-color;
        
        VerticalBox {
            padding: 12px;
            spacing: 8px;
            
            // Header
            HorizontalBox {
                Text {
                    text: "Find & Replace";
                    color: Theme.text-primary;
                    font-size: 14px;
                    font-weight: 600;
                    vertical-alignment: center;
                }
                
                Rectangle { horizontal-stretch: 1; }
                
                Rectangle {
                    width: 24px;
                    height: 24px;
                    background: close-touch.has-hover ? Theme.button-hover : transparent;
                    border-radius: 4px;
                    
                    close-touch := TouchArea {
                        clicked => { root.on-close(); }
                    }
                    
                    Image {
                        width: 12px;
                        height: 12px;
                        source: @image-url("../../assets/icons/ui/close.svg");
                        image-fit: contain;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
            
            // Search input
            HorizontalBox {
                spacing: 4px;
                
                Rectangle {
                    horizontal-stretch: 1;
                    height: 32px;
                    background: Theme.input-background;
                    border-radius: 4px;
                    border-width: 1px;
                    border-color: Theme.input-border;
                    
                    LineEdit {
                        text <=> root.search-text;
                        // placeholder-text: "Search...";
                    }
                }
                
                Rectangle {
                    width: 32px;
                    height: 32px;
                    background: prev-touch.has-hover ? Theme.button-hover : Theme.button-background;
                    border-radius: 4px;
                    
                    prev-touch := TouchArea {
                        clicked => { root.on-find-previous(); }
                    }
                    
                    Text {
                        text: "↑";
                        color: Theme.text-primary;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                Rectangle {
                    width: 32px;
                    height: 32px;
                    background: next-touch.has-hover ? Theme.button-hover : Theme.button-background;
                    border-radius: 4px;
                    
                    next-touch := TouchArea {
                        clicked => { root.on-find-next(); }
                    }
                    
                    Text {
                        text: "↓";
                        color: Theme.text-primary;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
            
            // Replace input
            HorizontalBox {
                spacing: 4px;
                
                Rectangle {
                    horizontal-stretch: 1;
                    height: 32px;
                    background: Theme.input-background;
                    border-radius: 4px;
                    border-width: 1px;
                    border-color: Theme.input-border;
                    
                    LineEdit {
                        text <=> root.replace-text;
                        // placeholder-text: "Replace with...";
                    }
                }
                
                Rectangle {
                    width: 70px;
                    height: 32px;
                    background: replace-touch.has-hover ? Theme.button-hover : Theme.button-background;
                    border-radius: 4px;
                    
                    replace-touch := TouchArea {
                        clicked => { root.on-replace(); }
                    }
                    
                    Text {
                        text: "Replace";
                        color: Theme.text-primary;
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                Rectangle {
                    width: 50px;
                    height: 32px;
                    background: replace-all-touch.has-hover ? Theme.button-hover : Theme.button-background;
                    border-radius: 4px;
                    
                    replace-all-touch := TouchArea {
                        clicked => { root.on-replace-all(); }
                    }
                    
                    Text {
                        text: "All";
                        color: Theme.text-primary;
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
            
            // Options
            HorizontalBox {
                spacing: 12px;
                
                CheckBox {
                    text: "Aa";
                    checked <=> root.case-sensitive;
                }
                
                CheckBox {
                    text: "Word";
                    checked <=> root.whole-word;
                }
                
                CheckBox {
                    text: ".*";
                    checked <=> root.use-regex;
                }
                
                Rectangle { horizontal-stretch: 1; }
                
                Text {
                    text: root.total-results > 0 ? 
                          (root.current-result + 1) + " of " + root.total-results :
                          "No results";
                    color: Theme.text-secondary;
                    font-size: 12px;
                    vertical-alignment: center;
                }
            }
            
            // Results list
            if root.results.length > 0: Rectangle {
                vertical-stretch: 1;
                background: Theme.background-secondary;
                border-radius: 4px;
                
                VerticalBox {
                    padding: 4px;
                    spacing: 2px;
                    
                    for result[idx] in root.results: Rectangle {
                        height: 32px;
                        background: idx == root.current-result ? Theme.selection-background :
                                    result-touch.has-hover ? Theme.explorer-item-hover : transparent;
                        border-radius: 4px;
                        
                        result-touch := TouchArea {
                            clicked => { root.on-select-result(result.entity-id); }
                        }
                        
                        HorizontalBox {
                            padding: 8px;
                            spacing: 8px;
                            
                            Text {
                                text: result.name;
                                color: Theme.text-primary;
                                vertical-alignment: center;
                            }
                            
                            Text {
                                horizontal-stretch: 1;
                                text: result.class-name;
                                color: Theme.text-secondary;
                                font-size: 11px;
                                vertical-alignment: center;
                            }
                        }
                    }
                }
            }
        }
    }
}
