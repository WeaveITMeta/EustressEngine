// ============================================================================
// Eustress Engine Studio - AI Generation Panel
// Text-to-mesh and AI generation queue
// ============================================================================

import { VerticalBox, HorizontalBox, LineEdit, ScrollView, Button, TextEdit } from "std-widgets.slint";
import { Theme, PanelHeader } from "theme.slint";

// Generation job data
export struct GenerationJob {
    id: int,
    prompt: string,
    status: string, // "queued", "generating", "completed", "failed"
    progress: float,
    result-preview: string,
    error-message: string,
}

component JobCard inherits Rectangle {
    in property <string> prompt: "";
    in property <string> status: "queued";
    in property <float> progress: 0;
    
    callback cancel();
    callback use-result();
    
    height: 80px;
    background: Theme.background-tertiary;
    border-radius: 4px;
    
    VerticalBox {
        padding: 8px;
        spacing: 4px;
        
        // Header
        HorizontalBox {
            Text {
                horizontal-stretch: 1;
                text: root.prompt;
                color: Theme.text-primary;
                font-size: 12px;
                overflow: elide;
            }
            
            // Status badge
            Rectangle {
                width: 70px;
                height: 20px;
                background: root.status == "completed" ? Theme.accent-green :
                           root.status == "failed" ? Theme.accent-red :
                           root.status == "generating" ? Theme.accent-blue :
                           Theme.text-secondary;
                border-radius: 10px;
                
                Text {
                    text: root.status == "completed" ? "Done" :
                          root.status == "failed" ? "Failed" :
                          root.status == "generating" ? "Working..." : "Queued";
                    color: white;
                    font-size: 10px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
        }
        
        // Progress bar
        if root.status == "generating": Rectangle {
            height: 4px;
            background: Theme.background-secondary;
            border-radius: 2px;
            
            Rectangle {
                width: parent.width * root.progress;
                height: 100%;
                background: Theme.accent-blue;
                border-radius: 2px;
            }
        }
        
        // Actions
        HorizontalBox {
            spacing: 8px;
            
            Rectangle { horizontal-stretch: 1; }
            
            if root.status == "queued" || root.status == "generating": Rectangle {
                width: 60px;
                height: 24px;
                background: Theme.button-background;
                border-radius: 4px;
                
                TouchArea {
                    clicked => { root.cancel(); }
                }
                
                Text {
                    text: "Cancel";
                    color: Theme.text-primary;
                    font-size: 11px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
            
            if root.status == "completed": Rectangle {
                width: 60px;
                height: 24px;
                background: Theme.button-primary;
                border-radius: 4px;
                
                TouchArea {
                    clicked => { root.use-result(); }
                }
                
                Text {
                    text: "Use";
                    color: white;
                    font-size: 11px;
                    horizontal-alignment: center;
                    vertical-alignment: center;
                }
            }
        }
    }
}

export component AIGeneration inherits Rectangle {
    // Properties
    in property <[GenerationJob]> jobs: [];
    in-out property <string> prompt-text: "";
    in property <string> generation-mode: "mesh"; // "mesh", "texture", "scene"
    
    // Callbacks
    callback on-generate();
    callback on-cancel-job(int);
    callback on-use-result(int);
    callback on-clear-completed();
    callback on-set-mode(string);
    
    background: Theme.panel-background;
    
    VerticalBox {
        padding: 0px;
        spacing: 0px;
        
        // Header
        PanelHeader {
            title: "AI Generation";
        }
        
        // Mode selector
        Rectangle {
            height: 36px;
            background: Theme.header-background;
            
            HorizontalBox {
                padding: 4px;
                spacing: 4px;
                
                Rectangle {
                    horizontal-stretch: 1;
                    background: root.generation-mode == "mesh" ? Theme.selection-background : transparent;
                    border-radius: 4px;
                    
                    TouchArea {
                        clicked => { root.on-set-mode("mesh"); }
                    }
                    
                    Text {
                        text: "üßä Mesh";
                        color: root.generation-mode == "mesh" ? Theme.text-primary : Theme.text-secondary;
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                Rectangle {
                    horizontal-stretch: 1;
                    background: root.generation-mode == "texture" ? Theme.selection-background : transparent;
                    border-radius: 4px;
                    
                    TouchArea {
                        clicked => { root.on-set-mode("texture"); }
                    }
                    
                    Text {
                        text: "üé® Texture";
                        color: root.generation-mode == "texture" ? Theme.text-primary : Theme.text-secondary;
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
                
                Rectangle {
                    horizontal-stretch: 1;
                    background: root.generation-mode == "scene" ? Theme.selection-background : transparent;
                    border-radius: 4px;
                    
                    TouchArea {
                        clicked => { root.on-set-mode("scene"); }
                    }
                    
                    Text {
                        text: "üåç Scene";
                        color: root.generation-mode == "scene" ? Theme.text-primary : Theme.text-secondary;
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }
        
        // Prompt input
        Rectangle {
            height: 100px;
            background: Theme.background-secondary;
            
            VerticalBox {
                padding: 8px;
                spacing: 8px;
                
                TextEdit {
                    vertical-stretch: 1;
                    text <=> root.prompt-text;
                    // placeholder-text: "Describe what you want to generate...";
                }
                
                HorizontalBox {
                    Rectangle { horizontal-stretch: 1; }
                    
                    Rectangle {
                        width: 100px;
                        height: 28px;
                        background: root.prompt-text == "" ? Theme.button-background : Theme.button-primary;
                        border-radius: 4px;
                        
                        TouchArea {
                            enabled: root.prompt-text != "";
                            clicked => { root.on-generate(); }
                        }
                        
                        Text {
                            text: "‚ú® Generate";
                            color: root.prompt-text == "" ? Theme.text-secondary : white;
                            font-size: 12px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
        
        // Queue header
        Rectangle {
            height: 32px;
            background: Theme.header-background;
            
            HorizontalBox {
                padding-left: 8px;
                padding-right: 8px;
                
                Text {
                    text: "Queue (" + root.jobs.length + ")";
                    color: Theme.text-primary;
                    font-weight: 500;
                    vertical-alignment: center;
                }
                
                Rectangle { horizontal-stretch: 1; }
                
                if root.jobs.length > 0: Rectangle {
                    width: 80px;
                    height: 24px;
                    background: Theme.button-background;
                    border-radius: 4px;
                    
                    TouchArea {
                        clicked => { root.on-clear-completed(); }
                    }
                    
                    Text {
                        text: "Clear Done";
                        color: Theme.text-primary;
                        font-size: 11px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }
        }
        
        // Job list
        if root.jobs.length == 0: Rectangle {
            vertical-stretch: 1;
            
            VerticalBox {
                alignment: center;
                
                Text {
                    text: "‚ú®";
                    color: Theme.text-secondary;
                    font-size: 32px;
                    horizontal-alignment: center;
                }
                
                Text {
                    text: "No generation jobs";
                    color: Theme.text-secondary;
                    font-size: 12px;
                    horizontal-alignment: center;
                }
            }
        }
        
        if root.jobs.length > 0: ScrollView {
            vertical-stretch: 1;
            
            VerticalBox {
                padding: 8px;
                spacing: 8px;
                
                for job in root.jobs: JobCard {
                    prompt: job.prompt;
                    status: job.status;
                    progress: job.progress;
                    
                    cancel => { root.on-cancel-job(job.id); }
                    use-result => { root.on-use-result(job.id); }
                }
            }
        }
    }
}
