// ============================================================================
// Eustress Engine Studio - Data Sources Dialog
// Manage global data sources (REST, GraphQL, PostgreSQL, etc.)
// ============================================================================

import { VerticalBox, HorizontalBox, LineEdit, ScrollView, ComboBox, Button } from "std-widgets.slint";
import { Theme, PanelHeader } from "theme.slint";

// Data source entry
export struct DataSourceEntry {
    id: int,
    name: string,
    source-type: string, // "REST", "GraphQL", "PostgreSQL", "CSV", etc.
    url: string,
    status: string, // "connected", "disconnected", "error"
}

export component DataSourcesDialog inherits Rectangle {
    // Properties
    in property <[DataSourceEntry]> sources: [];
    in-out property <int> selected-source: -1;
    in-out property <string> new-source-name: "";
    in-out property <string> new-source-type: "REST";
    in-out property <string> new-source-url: "";
    in-out property <bool> adding-source: false;
    
    // Callbacks
    callback on-add-source();
    callback on-remove-source(int);
    callback on-edit-source(int);
    callback on-test-source(int);
    callback on-close();
    
    width: 100%;
    height: 100%;
    background: Theme.modal-backdrop;
    
    TouchArea {
        clicked => { root.on-close(); }
    }
    
    Rectangle {
        x: (parent.width - self.width) / 2;
        y: (parent.height - self.height) / 2;
        width: 600px;
        height: 500px;
        background: Theme.dialog-background;
        border-radius: 8px;
        drop-shadow-blur: 20px;
        drop-shadow-color: Theme.shadow-color;
        
        TouchArea {}
        
        VerticalBox {
            padding: 0px;
            spacing: 0px;
            
            // Header
            Rectangle {
                height: 48px;
                background: Theme.header-background;
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
                
                HorizontalBox {
                    padding: 16px;
                    
                    Text {
                        text: "ðŸŒ Global Data Sources";
                        color: Theme.text-primary;
                        font-size: 18px;
                        font-weight: 600;
                        vertical-alignment: center;
                    }
                    
                    Rectangle { horizontal-stretch: 1; }
                    
                    Rectangle {
                        width: 28px;
                        height: 28px;
                        background: close-touch.has-hover ? Theme.button-hover : transparent;
                        border-radius: 4px;
                        
                        close-touch := TouchArea {
                            clicked => { root.on-close(); }
                        }
                        
                        Text {
                            text: "âœ•";
                            color: Theme.text-secondary;
                            font-size: 16px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }
            
            // Add new source form
            if root.adding-source: Rectangle {
                height: 120px;
                background: Theme.background-tertiary;
                
                VerticalBox {
                    padding: 12px;
                    spacing: 8px;
                    
                    HorizontalBox {
                        spacing: 8px;
                        
                        VerticalBox {
                            horizontal-stretch: 1;
                            spacing: 4px;
                            
                            Text {
                                text: "Name";
                                color: Theme.text-secondary;
                                font-size: 11px;
                            }
                            
                            Rectangle {
                                height: 28px;
                                background: Theme.input-background;
                                border-radius: 4px;
                                border-width: 1px;
                                border-color: Theme.input-border;
                                
                                LineEdit {
                                    text <=> root.new-source-name;
                                }
                            }
                        }
                        
                        VerticalBox {
                            width: 120px;
                            spacing: 4px;
                            
                            Text {
                                text: "Type";
                                color: Theme.text-secondary;
                                font-size: 11px;
                            }
                            
                            ComboBox {
                                height: 28px;
                                model: ["REST", "GraphQL", "PostgreSQL", "CSV", "Firebase", "Supabase"];
                                current-value <=> root.new-source-type;
                            }
                        }
                    }
                    
                    HorizontalBox {
                        spacing: 8px;
                        
                        VerticalBox {
                            horizontal-stretch: 1;
                            spacing: 4px;
                            
                            Text {
                                text: "URL / Connection String";
                                color: Theme.text-secondary;
                                font-size: 11px;
                            }
                            
                            Rectangle {
                                height: 28px;
                                background: Theme.input-background;
                                border-radius: 4px;
                                border-width: 1px;
                                border-color: Theme.input-border;
                                
                                LineEdit {
                                    text <=> root.new-source-url;
                                }
                            }
                        }
                        
                        Rectangle {
                            width: 60px;
                            height: 28px;
                            background: Theme.button-primary;
                            border-radius: 4px;
                            
                            TouchArea {
                                clicked => { root.on-add-source(); }
                            }
                            
                            Text {
                                text: "Add";
                                color: white;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                    }
                }
            }
            
            // Toolbar
            Rectangle {
                height: 40px;
                background: Theme.background-secondary;
                
                HorizontalBox {
                    padding: 8px;
                    spacing: 8px;
                    
                    Rectangle {
                        width: 100px;
                        height: 28px;
                        background: Theme.button-primary;
                        border-radius: 4px;
                        
                        TouchArea {
                            clicked => { root.adding-source = !root.adding-source; }
                        }
                        
                        Text {
                            text: root.adding-source ? "Cancel" : "+ Add Source";
                            color: white;
                            font-size: 12px;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                    
                    Rectangle { horizontal-stretch: 1; }
                }
            }
            
            // Sources list
            if root.sources.length == 0: Rectangle {
                vertical-stretch: 1;
                
                VerticalBox {
                    alignment: center;
                    
                    Text {
                        text: "ðŸŒ";
                        color: Theme.text-secondary;
                        font-size: 48px;
                        horizontal-alignment: center;
                    }
                    
                    Text {
                        text: "No data sources configured";
                        color: Theme.text-secondary;
                        horizontal-alignment: center;
                    }
                    
                    Text {
                        text: "Add a data source to connect to external APIs and databases";
                        color: Theme.text-disabled;
                        font-size: 12px;
                        horizontal-alignment: center;
                    }
                }
            }
            
            if root.sources.length > 0: ScrollView {
                vertical-stretch: 1;
                
                VerticalBox {
                    padding: 8px;
                    spacing: 4px;
                    
                    for source in root.sources: Rectangle {
                        height: 56px;
                        background: source.id == root.selected-source ? Theme.selection-background :
                                    source-touch.has-hover ? Theme.explorer-item-hover : transparent;
                        border-radius: 4px;
                        
                        source-touch := TouchArea {
                            clicked => { root.selected-source = source.id; }
                        }
                        
                        HorizontalBox {
                            padding: 12px;
                            spacing: 12px;
                            
                            // Status indicator
                            Rectangle {
                                width: 12px;
                                height: 12px;
                                background: source.status == "connected" ? Theme.accent-green :
                                           source.status == "error" ? Theme.accent-red :
                                           Theme.text-secondary;
                                border-radius: 6px;
                            }
                            
                            // Info
                            VerticalBox {
                                horizontal-stretch: 1;
                                spacing: 2px;
                                
                                Text {
                                    text: source.name;
                                    color: Theme.text-primary;
                                    font-weight: 500;
                                }
                                
                                Text {
                                    text: source.source-type + " â€¢ " + source.url;
                                    color: Theme.text-secondary;
                                    font-size: 11px;
                                    overflow: elide;
                                }
                            }
                            
                            // Actions
                            Rectangle {
                                width: 50px;
                                height: 28px;
                                background: Theme.button-background;
                                border-radius: 4px;
                                
                                TouchArea {
                                    clicked => { root.on-test-source(source.id); }
                                }
                                
                                Text {
                                    text: "Test";
                                    color: Theme.text-primary;
                                    font-size: 11px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                            }
                            
                            Rectangle {
                                width: 50px;
                                height: 28px;
                                background: Theme.button-background;
                                border-radius: 4px;
                                
                                TouchArea {
                                    clicked => { root.on-edit-source(source.id); }
                                }
                                
                                Text {
                                    text: "Edit";
                                    color: Theme.text-primary;
                                    font-size: 11px;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                            }
                            
                            Rectangle {
                                width: 28px;
                                height: 28px;
                                background: del-touch.has-hover ? Theme.accent-red : Theme.button-background;
                                border-radius: 4px;
                                
                                del-touch := TouchArea {
                                    clicked => { root.on-remove-source(source.id); }
                                }
                                
                                Text {
                                    text: "âœ•";
                                    color: del-touch.has-hover ? white : Theme.text-secondary;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }
                            }
                        }
                    }
                }
            }
            
            // Footer
            Rectangle {
                height: 48px;
                background: Theme.header-background;
                border-bottom-left-radius: 8px;
                border-bottom-right-radius: 8px;
                
                HorizontalBox {
                    padding: 12px;
                    alignment: end;
                    
                    Rectangle {
                        width: 80px;
                        height: 32px;
                        background: Theme.button-background;
                        border-radius: 4px;
                        
                        TouchArea {
                            clicked => { root.on-close(); }
                        }
                        
                        Text {
                            text: "Close";
                            color: Theme.text-primary;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
    }
}
