// ============================================================================
// Eustress Engine Studio - Asset Manager Panel
// Browse and import assets
// ============================================================================

import { VerticalBox, HorizontalBox, LineEdit, ScrollView, GridBox, ComboBox } from "std-widgets.slint";
import { Theme, PanelHeader } from "theme.slint";

// Asset data
export struct AssetData {
    id: string,
    name: string,
    asset-type: string,
    thumbnail: image,
    size: string,
    modified: string,
}

// Asset category
export struct AssetCategory {
    name: string,
    count: int,
}

component AssetCard inherits Rectangle {
    in property <string> name: "";
    in property <string> asset-type: "";
    in property <bool> selected: false;
    
    callback clicked();
    callback double-clicked();
    callback context-menu();
    
    width: 100px;
    height: 120px;
    background: self.selected ? Theme.selection-background : 
                touch.has-hover ? Theme.explorer-item-hover : transparent;
    border-radius: 4px;
    
    touch := TouchArea {
        clicked => { root.clicked(); }
        double-clicked => { root.double-clicked(); }
        pointer-event(event) => {
            if event.button == PointerEventButton.right && event.kind == PointerEventKind.up {
                root.context-menu();
            }
        }
    }
    
    VerticalBox {
        padding: 4px;
        spacing: 4px;
        
        // Thumbnail placeholder
        Rectangle {
            height: 80px;
            background: Theme.background-tertiary;
            border-radius: 4px;
            
            Image {
                width: 32px;
                height: 32px;
                source: root.asset-type == "Model" ? @image-url("../../assets/icons/ui/package.svg") :
                        root.asset-type == "Image" ? @image-url("../../assets/icons/ui/image.svg") :
                        root.asset-type == "Audio" ? @image-url("../../assets/icons/ui/audio.svg") :
                        root.asset-type == "Script" ? @image-url("../../assets/icons/ui/new-file.svg") :
                        @image-url("../../assets/icons/ui/new-file.svg");
                image-fit: contain;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
        
        // Name
        Text {
            text: root.name;
            color: Theme.text-primary;
            font-size: 11px;
            horizontal-alignment: center;
            overflow: elide;
        }
    }
}

// Reusable category tab button
component CategoryTab inherits Rectangle {
    in property <string> label: "";
    in property <bool> active: false;
    callback clicked();
    
    height: 28px;
    horizontal-stretch: 1;
    
    tab-touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
    }
    
    Rectangle {
        background: root.active ? Theme.panel-background : 
                    tab-touch.has-hover ? Theme.explorer-item-hover : transparent;
        border-radius: 4px;
        
        Text {
            text: root.label;
            color: root.active ? Theme.text-primary : Theme.text-secondary;
            font-size: 11px;
            horizontal-alignment: center;
            vertical-alignment: center;
        }
    }
    
    // Active indicator bar at bottom
    if root.active: Rectangle {
        y: parent.height - 2px;
        height: 2px;
        background: Theme.accent-blue;
        border-radius: 1px;
    }
}

export component AssetManager inherits Rectangle {
    // Properties
    in property <[AssetData]> assets: [];
    in property <[AssetCategory]> categories: [];
    in property <string> current-category: "All";
    in-out property <string> search-text: "";
    in property <string> sort-by: "Name";
    
    // Callbacks
    callback on-select-asset(string);
    callback on-import-asset(string);
    callback on-delete-asset(string);
    callback on-search-changed(string);
    callback on-category-changed(string);
    
    background: Theme.panel-background;
    
    VerticalLayout {
        padding: 0px;
        spacing: 0px;
        
        // Toolbar: Search + Import
        Rectangle {
            height: 36px;
            background: Theme.header-background;
            
            HorizontalLayout {
                padding: 4px;
                spacing: 6px;
                
                // Search icon
                Image {
                    width: 16px;
                    height: 16px;
                    source: @image-url("../../assets/icons/ui/search.svg");
                    image-fit: contain;
                    vertical-alignment: center;
                }
                
                // Search input
                LineEdit {
                    horizontal-stretch: 1;
                    placeholder-text: "Search assets...";
                    text <=> root.search-text;
                    edited(text) => { root.on-search-changed(text); }
                }
                
                // Import button
                Rectangle {
                    width: 70px;
                    height: 28px;
                    background: import-touch.has-hover ? #1a8ae6 : Theme.button-primary;
                    border-radius: 4px;
                    
                    import-touch := TouchArea {
                        mouse-cursor: pointer;
                        clicked => { root.on-import-asset(""); }
                    }
                    
                    HorizontalLayout {
                        alignment: center;
                        spacing: 4px;
                        
                        Image {
                            width: 12px;
                            height: 12px;
                            source: @image-url("../../assets/icons/ui/import.svg");
                            image-fit: contain;
                            vertical-alignment: center;
                        }
                        
                        Text {
                            text: "Import";
                            color: white;
                            font-size: 11px;
                            vertical-alignment: center;
                        }
                    }
                }
            }
        }
        
        // Category tabs â€” two rows to fit all types
        Rectangle {
            height: 56px;
            background: Theme.background-secondary;
            
            VerticalLayout {
                padding: 2px;
                spacing: 0px;
                
                // Row 1: All, Meshes, Images, Audio, Animation
                HorizontalLayout {
                    spacing: 2px;
                    padding-left: 4px;
                    padding-right: 4px;
                    
                    CategoryTab { label: "All"; active: root.current-category == "All"; clicked => { root.on-category-changed("All"); } }
                    CategoryTab { label: "Meshes"; active: root.current-category == "Meshes"; clicked => { root.on-category-changed("Meshes"); } }
                    CategoryTab { label: "Images"; active: root.current-category == "Images"; clicked => { root.on-category-changed("Images"); } }
                    CategoryTab { label: "Audio"; active: root.current-category == "Audio"; clicked => { root.on-category-changed("Audio"); } }
                    CategoryTab { label: "Anim"; active: root.current-category == "Animation"; clicked => { root.on-category-changed("Animation"); } }
                }
                
                // Row 2: Terrain, Scripts, Packages, Video, Fonts
                HorizontalLayout {
                    spacing: 2px;
                    padding-left: 4px;
                    padding-right: 4px;
                    
                    CategoryTab { label: "Terrain"; active: root.current-category == "Terrain"; clicked => { root.on-category-changed("Terrain"); } }
                    CategoryTab { label: "Scripts"; active: root.current-category == "Scripts"; clicked => { root.on-category-changed("Scripts"); } }
                    CategoryTab { label: "Packages"; active: root.current-category == "Packages"; clicked => { root.on-category-changed("Packages"); } }
                    CategoryTab { label: "Video"; active: root.current-category == "Video"; clicked => { root.on-category-changed("Video"); } }
                    CategoryTab { label: "Fonts"; active: root.current-category == "Fonts"; clicked => { root.on-category-changed("Fonts"); } }
                }
            }
        }
        
        // Asset grid or empty state
        if root.assets.length == 0: Rectangle {
            vertical-stretch: 1;
            
            Image {
                x: (parent.width - self.width) / 2;
                y: (parent.height - 80px) / 2;
                width: 48px;
                height: 48px;
                source: @image-url("../../assets/icons/ui/package.svg");
                image-fit: contain;
                opacity: 0.4;
            }
            
            Text {
                x: 0px;
                y: (parent.height - 80px) / 2 + 54px;
                width: 100%;
                text: "No assets found";
                color: Theme.text-secondary;
                horizontal-alignment: center;
            }
            
            Text {
                x: 0px;
                y: (parent.height - 80px) / 2 + 72px;
                width: 100%;
                text: "Import assets to get started";
                color: Theme.text-disabled;
                font-size: 12px;
                horizontal-alignment: center;
            }
        }
        
        if root.assets.length > 0: ScrollView {
            vertical-stretch: 1;
            
            VerticalLayout {
                padding: 8px;
                
                // Asset cards in a flow layout
                for asset in root.assets: AssetCard {
                    name: asset.name;
                    asset-type: asset.asset-type;
                    clicked => { root.on-select-asset(asset.id); }
                }
            }
        }
    }
}
