// ============================================================================
// Eustress Engine Studio - Toolbox Panel
// Part insertion tools and primitives
// ============================================================================

import { VerticalBox, HorizontalBox, ScrollView, GridBox } from "std-widgets.slint";
import { Theme, PanelHeader, IconButton } from "theme.slint";

// Tool category
export struct ToolCategory {
    name: string,
    icon: image,
    expanded: bool,
}

// Tool item
export struct ToolItem {
    id: string,
    name: string,
    icon: image,
    tooltip: string,
    category: string,
}

component ToolButton inherits Rectangle {
    in property <image> icon;
    in property <string> label: "";
    in property <string> tooltip: "";
    in property <bool> selected: false;
    
    callback clicked();
    
    width: 64px;
    height: 64px;
    background: self.selected ? Theme.selection-background : 
                touch.has-hover ? Theme.explorer-item-hover : transparent;
    border-radius: 4px;
    clip: false;
    
    touch := TouchArea {
        mouse-cursor: pointer;
        clicked => { root.clicked(); }
        moved => {
            if root.tooltip != "" {
                tb-popup.show();
            }
        }
    }
    
    VerticalLayout {
        padding: 4px;
        spacing: 2px;
        alignment: center;
        
        Image {
            source: root.icon;
            width: 24px;
            height: 24px;
            image-fit: contain;
            horizontal-alignment: center;
        }
        
        Text {
            text: root.label;
            color: Theme.text-secondary;
            font-size: 10px;
            horizontal-alignment: center;
            overflow: elide;
        }
    }
    
    // Tooltip popup â€” uses PopupWindow for correct z-ordering above all panels
    tb-popup := PopupWindow {
        x: 0px;
        y: root.height + 2px;
        
        Rectangle {
            background: #1e1e1e;
            border-radius: 3px;
            border-width: 1px;
            border-color: #3a3a3a;
            drop-shadow-blur: 4px;
            drop-shadow-color: #00000060;
            
            HorizontalBox {
                padding-left: 6px;
                padding-right: 6px;
                padding-top: 3px;
                padding-bottom: 3px;
                
                Text {
                    text: root.tooltip;
                    color: #d4d4d4;
                    font-size: 11px;
                }
            }
        }
    }
}

export component Toolbox inherits Rectangle {
    // Properties
    in property <string> current-tool: "select";
    in property <[ToolItem]> tools: [];
    
    // Callbacks
    callback on-select-tool(string);
    callback on-insert-part(string);
    
    background: Theme.panel-background;
    
    ScrollView {
        VerticalLayout {
            padding: 8px;
            spacing: 8px;
            
            // Primitives
            PanelHeader {
                title: "Primitives";
                collapsible: true;
            }
            
            // Row 1: 4 items
            Rectangle {
                height: 64px;
                property <length> row-w: 4 * 64px + 3 * 4px;
                ToolButton { x: (parent.width - parent.row-w) / 2 + 0 * 68px; icon: @image-url("../../assets/icons/ui/block.svg"); label: "Block"; clicked => { root.on-insert-part("Part"); } }
                ToolButton { x: (parent.width - parent.row-w) / 2 + 1 * 68px; icon: @image-url("../../assets/icons/ui/sphere.svg"); label: "Sphere"; clicked => { root.on-insert-part("SpherePart"); } }
                ToolButton { x: (parent.width - parent.row-w) / 2 + 2 * 68px; icon: @image-url("../../assets/icons/ui/wedge.svg"); label: "Wedge"; clicked => { root.on-insert-part("WedgePart"); } }
                ToolButton { x: (parent.width - parent.row-w) / 2 + 3 * 68px; icon: @image-url("../../assets/icons/ui/cylinder.svg"); label: "Cylinder"; clicked => { root.on-insert-part("CylinderPart"); } }
            }
            
            // Row 2: 2 items
            Rectangle {
                height: 64px;
                property <length> row-w: 2 * 64px + 1 * 4px;
                ToolButton { x: (parent.width - parent.row-w) / 2 + 0 * 68px; icon: @image-url("../../assets/icons/ui/corner.svg"); label: "Corner"; clicked => { root.on-insert-part("CornerWedgePart"); } }
                ToolButton { x: (parent.width - parent.row-w) / 2 + 1 * 68px; icon: @image-url("../../assets/icons/ui/truss.svg"); label: "Truss"; clicked => { root.on-insert-part("TrussPart"); } }
            }
            
            // Models
            PanelHeader {
                title: "Models";
                collapsible: true;
            }
            
            Rectangle {
                height: 64px;
                property <length> row-w: 2 * 64px + 1 * 4px;
                ToolButton { x: (parent.width - parent.row-w) / 2 + 0 * 68px; icon: @image-url("../../assets/icons/ui/package.svg"); label: "Model"; clicked => { root.on-insert-part("Model"); } }
                ToolButton { x: (parent.width - parent.row-w) / 2 + 1 * 68px; icon: @image-url("../../assets/icons/ui/group.svg"); label: "Folder"; clicked => { root.on-insert-part("Folder"); } }
            }
            
            // Lighting
            PanelHeader {
                title: "Lighting";
                collapsible: true;
            }
            
            Rectangle {
                height: 64px;
                property <length> row-w: 3 * 64px + 2 * 4px;
                ToolButton { x: (parent.width - parent.row-w) / 2 + 0 * 68px; icon: @image-url("../../assets/icons/ui/lightbulb.svg"); label: "Point"; clicked => { root.on-insert-part("PointLight"); } }
                ToolButton { x: (parent.width - parent.row-w) / 2 + 1 * 68px; icon: @image-url("../../assets/icons/ui/flashlight.svg"); label: "Spot"; clicked => { root.on-insert-part("SpotLight"); } }
                ToolButton { x: (parent.width - parent.row-w) / 2 + 2 * 68px; icon: @image-url("../../assets/icons/ui/lightbulb.svg"); label: "Surface"; clicked => { root.on-insert-part("SurfaceLight"); } }
            }
            
            // Physics
            PanelHeader {
                title: "Physics";
                collapsible: true;
            }
            
            Rectangle {
                height: 64px;
                property <length> row-w: 3 * 64px + 2 * 4px;
                ToolButton { x: (parent.width - parent.row-w) / 2 + 0 * 68px; icon: @image-url("../../assets/icons/ui/anchor.svg"); label: "Anchor"; clicked => { root.on-insert-part("Attachment"); } }
                ToolButton { x: (parent.width - parent.row-w) / 2 + 1 * 68px; icon: @image-url("../../assets/icons/ui/link.svg"); label: "Weld"; clicked => { root.on-insert-part("WeldConstraint"); } }
                ToolButton { x: (parent.width - parent.row-w) / 2 + 2 * 68px; icon: @image-url("../../assets/icons/ui/hinge.svg"); label: "Hinge"; clicked => { root.on-insert-part("HingeConstraint"); } }
            }
            
            // Scripts
            PanelHeader {
                title: "Scripts";
                collapsible: true;
            }
            
            Rectangle {
                height: 64px;
                ToolButton { x: (parent.width - 64px) / 2; icon: @image-url("../../assets/icons/soulservice.svg"); label: "Soul"; clicked => { root.on-insert-part("SoulScript"); } }
            }
        }
    }
}
