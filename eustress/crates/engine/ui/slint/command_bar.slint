// ============================================================================
// Eustress Engine Studio - Command Bar
// VS Code-style command palette (Ctrl+Shift+P)
// ============================================================================

import { VerticalBox, HorizontalBox, LineEdit, ScrollView } from "std-widgets.slint";
import { Theme } from "theme.slint";

// Command suggestion
export struct CommandSuggestion {
    id: string,
    label: string,
    description: string,
    shortcut: string,
    category: string,
}

export component CommandBar inherits Rectangle {
    // Properties
    in-out property <string> command-text: "";
    in property <[CommandSuggestion]> suggestions: [];
    in property <int> selected-index: 0;
    in property <[string]> history: [];
    
    // Callbacks
    callback on-execute(string);
    callback on-close();
    callback on-text-changed(string);
    callback on-select-suggestion(int);
    
    width: 100%;
    height: 40px;
    background: Theme.header-background;
    border-width: 1px;
    border-color: Theme.border-focus;
    
    HorizontalBox {
        padding: 4px;
        spacing: 8px;
        
        // Command icon
        Rectangle {
            width: 28px;
            
            Text {
                text: ">";
                color: Theme.accent-blue;
                font-size: 16px;
                font-weight: 700;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
        
        // Input field
        input := LineEdit {
            horizontal-stretch: 1;
            placeholder-text: "Type a command...";
            text <=> root.command-text;
            
            edited(text) => { root.on-text-changed(text); }
            
            accepted(text) => {
                root.on-execute(text);
                root.command-text = "";
            }
        }
        
        // Close button
        Rectangle {
            width: 28px;
            background: close-touch.has-hover ? Theme.button-hover : transparent;
            border-radius: 4px;
            
            close-touch := TouchArea {
                clicked => { root.on-close(); }
            }
            
            Text {
                text: "âœ•";
                color: Theme.text-secondary;
                font-size: 14px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }
    
    // Suggestions dropdown (shown when there are suggestions)
    if root.suggestions.length > 0: Rectangle {
        y: parent.height;
        width: parent.width;
        height: min(300px, root.suggestions.length * 36px + 8px);
        background: Theme.panel-background;
        border-width: 1px;
        border-color: Theme.border-color;
        drop-shadow-blur: 8px;
        drop-shadow-color: Theme.shadow-color;
        
        ScrollView {
            VerticalBox {
                padding: 4px;
                spacing: 2px;
                
                for suggestion[index] in root.suggestions: Rectangle {
                    height: 32px;
                    background: index == root.selected-index ? Theme.selection-background : 
                                suggestion-touch.has-hover ? Theme.explorer-item-hover : transparent;
                    border-radius: 4px;
                    
                    suggestion-touch := TouchArea {
                        clicked => { root.on-select-suggestion(index); }
                    }
                    
                    HorizontalBox {
                        padding-left: 8px;
                        padding-right: 8px;
                        spacing: 8px;
                        
                        // Category badge
                        Rectangle {
                            width: 60px;
                            height: 18px;
                            background: Theme.accent-blue;
                            border-radius: 2px;
                            
                            Text {
                                text: suggestion.category;
                                color: white;
                                font-size: 10px;
                                horizontal-alignment: center;
                                vertical-alignment: center;
                            }
                        }
                        
                        // Label
                        Text {
                            horizontal-stretch: 1;
                            text: suggestion.label;
                            color: Theme.text-primary;
                            vertical-alignment: center;
                        }
                        
                        // Shortcut
                        if suggestion.shortcut != "": Rectangle {
                            width: 80px;
                            
                            Text {
                                text: suggestion.shortcut;
                                color: Theme.text-secondary;
                                font-size: 11px;
                                horizontal-alignment: right;
                                vertical-alignment: center;
                            }
                        }
                    }
                }
            }
        }
    }
}
