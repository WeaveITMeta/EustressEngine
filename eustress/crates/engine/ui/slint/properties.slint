// ============================================================================
// Eustress Engine Studio - Properties Panel
// Dynamic property editor for selected entities
// ============================================================================

import { VerticalBox, HorizontalBox, LineEdit, ScrollView, CheckBox, Slider, ComboBox, SpinBox, GridBox } from "std-widgets.slint";
import { Theme } from "theme.slint";

// Property data structure
export struct PropertyData {
    name: string,
    value: string,
    property-type: string, // "string", "float", "int", "bool", "vec3", "color", "enum"
    category: string,
    editable: bool,
    options: [string], // For enum types
    // Section header flag: if true, this entry is a category header (not a property)
    is-header: bool,
}

// Collapsible section header
component SectionHeader inherits Rectangle {
    in property <string> title: "";
    in-out property <bool> expanded: true;
    
    height: 28px;
    background: Theme.header-background;
    
    TouchArea {
        clicked => { root.expanded = !root.expanded; }
    }
    
    HorizontalLayout {
        padding-left: 8px;
        padding-right: 8px;
        spacing: 6px;
        
        // Chevron
        Text {
            width: 12px;
            text: root.expanded ? "▾" : "▸";
            color: Theme.text-secondary;
            font-size: 10px;
            vertical-alignment: center;
        }
        
        Text {
            text: root.title;
            color: Theme.text-primary;
            font-size: 11px;
            font-weight: 600;
            vertical-alignment: center;
        }
    }
}

// Generic property row with label + value editor
component PropRow inherits Rectangle {
    in property <string> label: "";
    in property <string> value: "";
    in property <string> prop-type: "string";
    in property <bool> editable: true;
    
    callback value-changed(string);
    
    height: 26px;
    background: touch.has-hover ? #ffffff06 : transparent;
    
    touch := TouchArea {}
    
    HorizontalLayout {
        padding-left: 12px;
        padding-right: 8px;
        spacing: 8px;
        
        // Label
        Text {
            width: 90px;
            text: root.label;
            color: Theme.text-secondary;
            font-size: 11px;
            vertical-alignment: center;
            overflow: elide;
        }
        
        // Value editor
        if root.editable: LineEdit {
            horizontal-stretch: 1;
            text: root.value;
            edited(text) => { root.value-changed(text); }
        }
        
        if !root.editable: Text {
            horizontal-stretch: 1;
            text: root.value;
            color: Theme.text-primary;
            font-size: 11px;
            vertical-alignment: center;
            overflow: elide;
        }
    }
}

// Vec3 property row with colored X/Y/Z fields
component Vec3Row inherits Rectangle {
    in property <string> label: "";
    in property <string> value: ""; // "x, y, z" format
    in property <bool> editable: true;
    
    callback value-changed(string);
    
    height: 26px;
    background: transparent;
    
    HorizontalLayout {
        padding-left: 12px;
        padding-right: 8px;
        spacing: 4px;
        
        // Label
        Text {
            width: 90px;
            text: root.label;
            color: Theme.text-secondary;
            font-size: 11px;
            vertical-alignment: center;
            overflow: elide;
        }
        
        // X field
        Rectangle {
            horizontal-stretch: 1;
            background: Theme.input-background;
            border-radius: 2px;
            border-width: 1px;
            border-color: Theme.input-border;
            
            HorizontalLayout {
                padding-left: 2px;
                padding-right: 2px;
                spacing: 2px;
                
                Text {
                    width: 12px;
                    text: "X";
                    color: Theme.gizmo-x;
                    font-size: 9px;
                    font-weight: 700;
                    vertical-alignment: center;
                    horizontal-alignment: center;
                }
                
                LineEdit {
                    horizontal-stretch: 1;
                    text: "0";
                    input-type: decimal;
                }
            }
        }
        
        // Y field
        Rectangle {
            horizontal-stretch: 1;
            background: Theme.input-background;
            border-radius: 2px;
            border-width: 1px;
            border-color: Theme.input-border;
            
            HorizontalLayout {
                padding-left: 2px;
                padding-right: 2px;
                spacing: 2px;
                
                Text {
                    width: 12px;
                    text: "Y";
                    color: Theme.gizmo-y;
                    font-size: 9px;
                    font-weight: 700;
                    vertical-alignment: center;
                    horizontal-alignment: center;
                }
                
                LineEdit {
                    horizontal-stretch: 1;
                    text: "0";
                    input-type: decimal;
                }
            }
        }
        
        // Z field
        Rectangle {
            horizontal-stretch: 1;
            background: Theme.input-background;
            border-radius: 2px;
            border-width: 1px;
            border-color: Theme.input-border;
            
            HorizontalLayout {
                padding-left: 2px;
                padding-right: 2px;
                spacing: 2px;
                
                Text {
                    width: 12px;
                    text: "Z";
                    color: Theme.gizmo-z;
                    font-size: 9px;
                    font-weight: 700;
                    vertical-alignment: center;
                    horizontal-alignment: center;
                }
                
                LineEdit {
                    horizontal-stretch: 1;
                    text: "0";
                    input-type: decimal;
                }
            }
        }
    }
}

// Color property row with swatch + hex value
component ColorRow inherits Rectangle {
    in property <string> label: "";
    in property <string> value: "#808080";
    in property <bool> editable: true;
    
    callback value-changed(string);
    
    height: 26px;
    background: transparent;
    
    HorizontalLayout {
        padding-left: 12px;
        padding-right: 8px;
        spacing: 8px;
        
        // Label
        Text {
            width: 90px;
            text: root.label;
            color: Theme.text-secondary;
            font-size: 11px;
            vertical-alignment: center;
            overflow: elide;
        }
        
        // Color swatch
        Rectangle {
            width: 22px;
            height: 18px;
            // Checkerboard background for transparency
            background: #808080;
            border-radius: 3px;
            border-width: 1px;
            border-color: Theme.border-color;
            
            TouchArea {
                clicked => {
                    // TODO: Open color picker
                }
            }
        }
        
        // Hex input
        if root.editable: LineEdit {
            horizontal-stretch: 1;
            text: root.value;
            edited(text) => { root.value-changed(text); }
        }
        
        if !root.editable: Text {
            horizontal-stretch: 1;
            text: root.value;
            color: Theme.text-primary;
            font-size: 11px;
            vertical-alignment: center;
        }
    }
}

// Bool property row with true/false toggle
component BoolRow inherits Rectangle {
    in property <string> label: "";
    in property <string> value: "false";
    in property <bool> editable: true;
    
    callback value-changed(string);
    
    height: 26px;
    background: touch.has-hover ? #ffffff06 : transparent;
    
    touch := TouchArea {
        clicked => {
            if root.editable {
                root.value-changed(root.value == "true" ? "false" : "true");
            }
        }
    }
    
    HorizontalLayout {
        padding-left: 12px;
        padding-right: 8px;
        spacing: 8px;
        
        // Label
        Text {
            width: 90px;
            text: root.label;
            color: Theme.text-secondary;
            font-size: 11px;
            vertical-alignment: center;
            overflow: elide;
        }
        
        // Checkbox visual
        Rectangle {
            width: 16px;
            height: 16px;
            background: root.value == "true" ? Theme.accent-blue : Theme.input-background;
            border-radius: 3px;
            border-width: 1px;
            border-color: root.value == "true" ? Theme.accent-blue : Theme.input-border;
            
            if root.value == "true": Text {
                text: "✓";
                color: white;
                font-size: 11px;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
        
        Text {
            horizontal-stretch: 1;
            text: root.value;
            color: Theme.text-primary;
            font-size: 11px;
            vertical-alignment: center;
        }
    }
}

export component PropertiesPanel inherits Rectangle {
    // Properties
    in property <int> selected-count: 0;
    in property <string> selected-class: "";
    in property <[PropertyData]> properties: [];
    
    // Callbacks
    callback on-property-changed(string, string);
    
    background: Theme.panel-background;
    
    VerticalLayout {
        padding: 0px;
        spacing: 0px;
        
        // Header showing selection info
        Rectangle {
            height: 32px;
            background: Theme.header-background;
            
            HorizontalLayout {
                padding-left: 8px;
                padding-right: 8px;
                
                Text {
                    text: root.selected-count == 0 ? "No selection" :
                          root.selected-count == 1 ? root.selected-class :
                          root.selected-count + " objects selected";
                    color: Theme.text-primary;
                    font-weight: 500;
                    font-size: 12px;
                    vertical-alignment: center;
                }
            }
        }
        
        // Empty state
        if root.selected-count == 0: Rectangle {
            vertical-stretch: 1;
            
            VerticalLayout {
                alignment: center;
                
                Text {
                    text: "Select an object to view its properties";
                    color: Theme.text-secondary;
                    font-size: 11px;
                    horizontal-alignment: center;
                }
            }
        }
        
        // Dynamic property list — fully driven by Rust binding
        if root.selected-count > 0: ScrollView {
            vertical-stretch: 1;
            
            VerticalLayout {
                padding: 0px;
                spacing: 0px;
                alignment: start;
                
                for prop in root.properties: VerticalLayout {
                    spacing: 0px;
                    
                    // Category header
                    if prop.is-header: SectionHeader {
                        title: prop.category;
                    }
                    
                    // Vec3 property
                    if !prop.is-header && prop.property-type == "vec3": Vec3Row {
                        label: prop.name;
                        value: prop.value;
                        editable: prop.editable;
                        value-changed(val) => { root.on-property-changed(prop.name, val); }
                    }
                    
                    // Color property
                    if !prop.is-header && prop.property-type == "color": ColorRow {
                        label: prop.name;
                        value: prop.value;
                        editable: prop.editable;
                        value-changed(val) => { root.on-property-changed(prop.name, val); }
                    }
                    
                    // Bool property
                    if !prop.is-header && prop.property-type == "bool": BoolRow {
                        label: prop.name;
                        value: prop.value;
                        editable: prop.editable;
                        value-changed(val) => { root.on-property-changed(prop.name, val); }
                    }
                    
                    // String / float / int / enum — generic row
                    if !prop.is-header && prop.property-type != "vec3" && prop.property-type != "color" && prop.property-type != "bool": PropRow {
                        label: prop.name;
                        value: prop.value;
                        prop-type: prop.property-type;
                        editable: prop.editable;
                        value-changed(val) => { root.on-property-changed(prop.name, val); }
                    }
                }
            }
        }
    }
}
